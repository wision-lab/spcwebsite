{% extends "base.html" %}
{% load custom_filters %}

{% block content %}

{% if page_obj %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tableRows = document.querySelectorAll('tbody tr.entry');
        const compareBtn = document.getElementById('compare-btn');
        const toggle = document.getElementById('collapse-toggle');
        var selectedRows = [];
 
        compareBtn.addEventListener('click', function() {
            event.preventDefault();
            window.location.href = 'compare/' + selectedRows.join("/");
        });
 
        tableRows.forEach(row => {
            row.addEventListener('click', function() {                
                if (this.classList.contains('selected-row')) {
                    // Turn off and remove from selectedRows if present
                    this.classList.remove('selected-row');
                    const index = selectedRows.indexOf(this.id);
                    if (index > -1) {
                        selectedRows.splice(index, 1);
                    }
                } else {
                    // Turn on and shift out any extra rows 
                    this.classList.add('selected-row');
                    selectedRows.push(this.id)
 
                    if (selectedRows.length > 2) {
                        var to_remove = selectedRows.shift();
                        document.getElementById(to_remove).classList.toggle('selected-row');
                    }
                }
 
                if (selectedRows.length == 2) {
                    compareBtn.style.display = 'flex';
                } else {
                    compareBtn.style.display = 'none';
                }
            });
        });
 
        if (toggle) {
            toggle.addEventListener('change', function() {
                const url = new URL(window.location.href);
                if (this.checked) {
                    url.searchParams.set('collapse', '1');
                } else {
                    url.searchParams.delete('collapse');
                }
                // Reset to page 1 when toggling
                url.searchParams.delete('page');
                window.location.href = url.toString();
            });
        }
    });
</script>

<div class="reconstruction-header">
    <h4 style="margin: 0;">Reconstruction Results</h4>
    {% if creator is not none %}
        <span class="filter-status">
            {% if user.id|stringformat:"s" == creator %}Viewing your entries{% else %}Viewing entries of selected user{% endif %}
            <a href="{% url 'eval:reconstruction' %}{% if sortby %}?sortby={% if not direction %}-{% endif %}{{ sortby }}{% endif %}" class="clear-filter" title="Show all entries">Ã—</a>
        </span>
    {% else %}
        <label class="toggle-container" title="Show only the top-ranked entry for each participant (for the selected metric)">
            <span>Collapse Users</span>
            <div class="toggle-switch">
                <input type="checkbox" id="collapse-toggle" {% if collapse %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </div>
        </label>
    {% endif %}
</div>

<div style="overflow-x:auto;">
<table style="margin: 0;">
    <tr>
        <th style="width:0;">#</th>
        <th style="min-width: 30ch;">
            <div class="namebox">
                Name&nbsp;<a href="#" class="codebutton" style="padding: 0.5em; display: none;" id="compare-btn">Compare Results</a>
            </div>
        </th>
        
        {% for metric in metric_fields %}
        <th class="{% if forloop.counter0|divisibleby:3 %}leftbig{% endif %} clickable {% if sortby == metric.name %}sorted-col{% endif %}">
            <a href="{% url 'eval:reconstruction' %}?sortby={% if direction and sortby == metric.name %}-{% endif %}{{ metric.name }}{% if collapse %}&collapse=1{% endif %}{% if creator is not none %}&creator={{ creator }}{% endif %}">
                <p style="display: inline;">{{ metric.verbose_name|linebreaksbr }}</p>
                <span style="display: inline;">{% if sortby == metric.name %}{% if not direction %}â–²{% else %}â–¼{% endif %}{% endif %}</span>
            </a>
        </th>
        {% endfor %}
    </tr>

    {% for entry in page_obj %}
    <tr class="entry" id="{{ entry.id }}">
        <td>
            {{ forloop.counter0|add:page_obj.start_index }}
        </td>
        <td>
            <div class="namebox">
                <a href="{% url 'eval:detail' entry.id %}">
                    {% if entry.visibility == "PRIV" %}<span style="font-size: small;">{% if entry.creator.id != user.id %}ðŸ¥¸{% else %}ðŸš«{% endif %}</span>&nbsp;&nbsp;{% endif %}{{ entry.name|truncatechars:50 }}
                </a>
                <div style="margin-left: auto; display: flex; gap: 5px; align-items: center;">
                    {% if entry.visibility != "ANON" and entry.code_url|length > 0 %}
                        <a href="{{ entry.code_url }}" target="_blank" rel="noopener noreferrer" class="badge">Code</a>
                    {% endif %}
                    {% if entry.collapsed_count > 1 %}
                    <a href="{% url 'eval:reconstruction' %}?creator={{ entry.creator.id }}{% if sortby %}&sortby={% if not direction %}-{% endif %}{{ sortby }}{% endif %}" class="collapsed-badge-link">
                        <span class="badge" title="Click to view all {{ entry.collapsed_count }} submissions by this user.">
                            {% if direction %}Best{% else %}Worst{% endif %} of {{ entry.collapsed_count }}
                        </span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </td>
        {% for m_field, metric_val in metric_fields|zip:entry.metrics %}
        <td class="num {% if forloop.counter0|divisibleby:3 %}leftbig{% endif %} {% if sortby == m_field.name %}sorted-col{% endif %}">
            {{ metric_val|na_if_missing:3 }}
        </td>
        {% endfor %}
    </tr>
    <tr>
        <td class="citation"></td>
        <td class="citation" colspan="{{ metric_fields|length|add:1 }}" style="max-width: 1vw; overflow-x: clip; text-overflow: ellipsis;">
            {% if entry.visibility == "ANON" %}
                Anonymous.
            {% else %}
                {% if entry.citation|length > 0 %}
                    {{ entry.citation }}
                {% else %}
                    &nbsp;
                {% endif %}
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
</div>
<div class="pagination">
    <nav>
        {% if page_obj.has_previous %}
            <a href="?page=1{% if sortby %}&sortby={% if not direction %}-{% endif %}{{ sortby }}{% endif %}{% if collapse %}&collapse=1{% endif %}{% if creator is not none %}&creator={{ creator }}{% endif %}">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if sortby %}&sortby={% if not direction %}-{% endif %}{{ sortby }}{% endif %}{% if collapse %}&collapse=1{% endif %}{% if creator is not none %}&creator={{ creator }}{% endif %}">Previous</a>
        {% endif %}

        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if sortby %}&sortby={% if not direction %}-{% endif %}{{ sortby }}{% endif %}{% if collapse %}&collapse=1{% endif %}{% if creator is not none %}&creator={{ creator }}{% endif %}">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if sortby %}&sortby={% if not direction %}-{% endif %}{{ sortby }}{% endif %}{% if collapse %}&collapse=1{% endif %}{% if creator is not none %}&creator={{ creator }}{% endif %}">Last &raquo;</a>
        {% endif %}
    </nav>
</div>

<p>
    Entries marked with ðŸ’¡ have been submitted by the SPC team as baselines.</br>
    {% if user.is_verified %}
    Entries marked with ðŸš« are your private results and are only be visible to you.</br>
    {% if user.is_superuser %}Entries marked with ðŸ¥¸ are private results <u><i>from other users</i></u> and are only be visible to admins.</br>{% endif %} 
    {% endif %}
</p>
<p><u>Note:</u> Submissions waiting for evaluation will not be shown here.</p>
<p><i>Tip: Select two rows to in order to compare them!</i></p>
{% else %}
<p>No data available.</p>
{% endif %}
{% endblock %}